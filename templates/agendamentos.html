<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Agendamento</title>

    <script>
        function carregarHorarios() {
            const data = document.getElementById("data").value;
            const horarioSelect = document.getElementById("horario");

            horarioSelect.innerHTML = "<option>Carregando...</option>";

            fetch(`/horarios?data=${encodeURIComponent(data)}`)
                .then(response => response.json())
                .then(dados => {
                    horarioSelect.innerHTML = "";

                    if (dados.horarios.length === 0) {
                        horarioSelect.innerHTML = "<option>Nenhum hor√°rio dispon√≠vel</option>";
                    } else {
                        dados.horarios.forEach(h => {
                            const opt = document.createElement("option");
                            opt.value = h;
                            opt.textContent = h;
                            horarioSelect.appendChild(opt);
                        });
                    }
                });
        }

        function enviarWhatsApp() {
            const servico = "{{ servico }}";
            const veiculo = "{{ veiculo }}";
            const extra = "{{ extra_nome }}";
            const preco = "{{ preco_final }}";
            const data = document.getElementById("data").value;
            const horario = document.getElementById("horario").value;

            if (!data || !horario) {
                alert("Selecione data e hor√°rio!");
                return;
            }

            const msg = `Ol√°! Quero agendar:%0A%0A` +
                `‚Ä¢ Servi√ßo: ${servico}%0A` +
                `‚Ä¢ Ve√≠culo: ${veiculo}%0A` +
                `‚Ä¢ Extra: ${extra}%0A` +
                `‚Ä¢ Data: ${data}%0A` +
                `‚Ä¢ Hor√°rio: ${horario}%0A` +
                `‚Ä¢ Valor Total: R$ ${preco}%0A%0A`;

            const url = `https://wa.me/5551999522076?text=${msg}`;
            window.open(url, "_blank");
        }
    </script>

</head>

<body>

<h2>Finalizar Agendamento</h2>

<div class="card">

    <p><strong>Servi√ßo:</strong> {{ servico }}</p>
    <p><strong>Ve√≠culo:</strong> {{ veiculo }}</p>
    <p><strong>Extra:</strong> {{ extra_nome }} ‚Äî R$ {{ extra_valor }}</p>
    <p><strong>Total:</strong> R$ {{ preco_final }}</p>

    <!-- üî• SELECT DE DATAS CORRIGIDO -->
    <label class="label">Selecione a Data:</label>
    <select id="data" onchange="carregarHorarios()">
        {% for d in datas %}
            <option value="{{ d }}">{{ d }}</option>
        {% endfor %}
    </select>

    <!-- üî• SELECT DE HOR√ÅRIOS CORRETO -->
    <label class="label">Selecione o Hor√°rio:</label>
    <select id="horario">
        <option>Selecione uma data primeiro...</option>
    </select>

    <button class="btn-whatsapp" onclick="enviarWhatsApp()">Confirmar no WhatsApp</button>

    <a class="btn-voltar" href="/servicos">‚Üê Voltar</a>
</div>

</body>
</html>